<!doctype html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<script type="text/javascript" src="../../dist/audiorecorder.js"></script>
	</head>
	<body>		
		<script>
			function showtext(str, url = null) {
				const newDiv = document.createElement("div");
				newDiv.appendChild(document.createTextNode(str));
				document.getElementById("debugLog").prepend(newDiv);
			}
			
			function showrecording(url) {
				// Download link
				const newA = document.createElement("a");
				newA.href = url;
				newA.download = "recording.mp3";
				newA.appendChild(document.createTextNode("Save mp3 file"));
				document.getElementById("debugLog").prepend(newA);
				
				// Embedded audio player
				const newAudio = document.createElement("audio");
				newAudio.src = url;
				newAudio.controls = true;
				document.getElementById("debugLog").prepend(newAudio);
			}
			
			// Enable only the listed buttons
			function showbuttons(enabledButtons) {
				const buttons = ["start", "stop", "pause", "resume"];
				
				for (let buttonName of buttons) {
					document.getElementById("id_" + buttonName).disabled = !enabledButtons.includes(buttonName);
				}
			}
			
			let audioData = []; // Store the encoded MP3 data chunks
			let recorder = null;
			
			// Preload the worker immediately on page load to enable recording to start instantly
			// Either the worklet OR worker will be preloaded, depending on the browser support.
			// If preloading is used, the workletUrl and workerUrl passed to AudioRecorder will be ignored.
			AudioRecorder.preload({
				workletUrl : "../../dist/mp3worklet.js",
				workerUrl : "../../dist/mp3worker.js",
				
				// Used for debugging only. Preload both the worklet and worker.
				preloadBoth : true
			});
			
			function setupRecorder() {
				audioData = []; // clear old recorded data
				
				recorder = new AudioRecorder({
					recordingGain : 1, // Initial recording volume
					numberOfChannels : 1, // Channels. Currently only tested with one.
					encoderBitRate : 96, // MP3 bit rate
					//streaming : true, // Data will be returned in chunks (ondataavailable callback) as it is encoded,
										// rather than at the end as one large blob
					streamBufferSize : 50000, // Size of encoded mp3 data chunks returned by ondataavailable					
					constraints : { // Optional audio constraints, see https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
						autoGainControl : true,
						echoCancellation : true,
						noiseSuppression : true
					},
					
					// Used for debugging only. Force using the older script processor instead of AudioWorklet.
					// Will break preloading unless preloadBoth was used.
					forceScriptProcessor : document.getElementById("id_forceScriptProcessor").checked,
				});
				
				recorder.ondataavailable = (data) => {
					console.log("data", data.length);
					audioData.push(data);
				};
				
				recorder.onstart = () => {
					showtext("Recording started");
					showbuttons(["stop", "pause"]);
				};
				
				recorder.onstop = () => {
					showtext("Recording stopped");
					// Combine all the mp3 data chunks from the audioData array into a Blob
					let mp3Blob = new Blob(audioData, {type : "audio/mpeg"});
					let mp3BlobUrl = URL.createObjectURL(mp3Blob);
					showrecording(mp3BlobUrl);
					showbuttons(["start"]);
				};
				
				recorder.onerror = (error) => {
					console.log(error);
					showtext("Recording error " + String(error));
				};
			}
			
			function startRecording() {
				// It's not necessary to set up the audio recorder each time, but we do
				// it to allow enabling/disabling of the forceScriptProcessor option.
				setupRecorder();
				
				showtext("Recording starting...");
				recorder.start();
				showbuttons([]);
			}
			
			function stopRecording() {
				showtext("Stopping...");
				recorder.stop();
				showbuttons([]);
			}
			
			function pause() {
				showtext("Pausing");
				recorder.pause();
				showbuttons(["stop", "resume"]);
			}
			
			function resume() {
				showtext("Resuming");
				recorder.resume();
				showbuttons(["stop", "pause"]);
			}
		</script>
		
		<button id="id_start" onclick="startRecording()">start recording</button>
		<button id="id_stop" disabled onclick="stopRecording()">stop recording</button>
		<button id="id_pause" disabled onclick="pause()">pause</button>
		<button id="id_resume" disabled onclick="resume()">resume</button>
		force using old script processor: <input id="id_forceScriptProcessor" type="checkbox"></input>
		
		<div id="debugLog"></div>
	</body>
</html>
